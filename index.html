<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cardápio Digital - Restaurante</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', 'Inter', sans-serif; }
        #modal-overlay { display: none; }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-utensils"></i>
                    <h1>Sabor & Cia</h1>
                </div>
                <div class="header-actions" id="headerActions">
                    <!-- Botão "repetir último pedido" será inserido aqui -->
                </div>
            </div>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="hero">
        <div class="container">
            <div class="hero-content">
                <h2>Bem-vindo ao nosso Cardápio Digital</h2>
                <p>Descubra sabores únicos e faça seu pedido com facilidade</p>
            </div>
        </div>
    </section>

    <!-- Categories Navigation -->
    <nav class="categories-nav">
        <div class="container">
            <div class="categories-list" id="categoriesList">
                <!-- Categorias serão carregadas dinamicamente -->
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <div class="content-wrapper">
                <!-- Products Section -->
                <section class="products-section">
                    <div class="products-grid" id="productsGrid">
                        <!-- Produtos serão carregados dinamicamente -->
                    </div>
                </section>
            </div>
        </div>
    </main>

    <!-- Footer Cart Summary Bar -->
    <div class="footer-cart-bar" id="footerCartBar" style="display: none;" onclick="toggleCart()" role="button" aria-label="Abrir carrinho">
        <div class="container">
            <div class="footer-cart-content">
                <div class="footer-cart-info">
                    <i class="bi bi-basket footer-cart-icon"></i>
                    <div class="footer-cart-text">
                        <span class="footer-cart-title">Seu pedido</span>
                        <span class="footer-cart-meta"><span id="footerCartCount">0</span> itens • Subtotal <strong id="footerCartSubtotal">R$ 0,00</strong></span>
                    </div>
                </div>
                <i class="bi bi-chevron-up footer-cart-chevron" aria-hidden="true"></i>
            </div>
        </div>
    </div>

    <!-- Cart Sidebar -->
    <div class="cart-sidebar" id="cartSidebar">
        <div class="cart-header">
            <div class="sheet-handle" aria-hidden="true"></div>
            <h3><i class="fas fa-shopping-cart"></i> Seu Pedido</h3>
            <button class="close-cart" onclick="toggleCart()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="cart-content">
            <div class="cart-items" id="cartItems">
                <!-- Itens do carrinho serão adicionados dinamicamente -->
            </div>
            
            <div class="cart-empty" id="cartEmpty">
                <i class="fas fa-shopping-cart"></i>
                <p>Seu carrinho está vazio</p>
                <small>Adicione alguns itens deliciosos!</small>
            </div>
        </div>
        
        <div class="cart-footer" id="cartFooter" style="display: none;">
            <div class="cart-summary">
                <div class="summary-row">
                    <span>Subtotal:</span>
                    <span id="cartSubtotal">R$ 0,00</span>
                </div>
                <div class="summary-row">
                    <span>Taxa de entrega:</span>
                    <span id="deliveryFee">A calcular</span>
                </div>
                <div class="summary-row total">
                    <span>Total:</span>
                    <span id="cartTotal">R$ 0,00</span>
                </div>
                <div class="delivery-note">A taxa de entrega será calculada após informar o endereço no checkout.</div>
            </div>
            
            <!-- Botão de sugestão dinâmico -->
            <button type="button" id="cartSuggestion" class="suggestion-btn" style="display:none;" onclick="handleSuggestionClick(this)" aria-label="Sugestão de produto">
                <span class="suggestion-text">Continuar comprando</span>
                <i class="bi bi-chevron-right"></i>
            </button>
            
            <button class="checkout-btn" onclick="proceedToCheckout()">
                <i class="fas fa-credit-card"></i>
                Finalizar Pedido
            </button>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div class="modal-overlay" id="checkoutModal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-clipboard-list"></i> Finalizar Pedido</h3>
                <button class="close-modal" onclick="closeCheckoutModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-content">
                <div class="checkout-progress" id="checkoutProgress">
                    <div class="progress-step active" data-step="1">
                        <span class="step-number">1</span>
                        <span class="step-label">Pedido</span>
                    </div>
                    <div class="progress-step" data-step="2">
                        <span class="step-number">2</span>
                        <span class="step-label">Dados</span>
                    </div>
                    <div class="progress-step" data-step="3">
                        <span class="step-number">3</span>
                        <span class="step-label">Endereço</span>
                    </div>
                    <div class="progress-step" data-step="4">
                        <span class="step-number">4</span>
                        <span class="step-label">Pagamento</span>
                    </div>
                    <div class="progress-step" data-step="5">
                        <span class="step-number">5</span>
                        <span class="step-label">Resumo</span>
                    </div>
                </div>
                <form id="checkoutForm">
                    <div class="checkout-step active" id="checkout-step-1">
                        <div class="form-section">
                            <h4><i class="fas fa-receipt"></i> Tipo de Pedido</h4>
                            <div class="payment-options order-type-options">
                                <label class="payment-option">
                                    <input type="radio" name="orderType" value="retirada">
                                    <span class="payment-label"><i class="fas fa-bag-shopping"></i> Retirada</span>
                                </label>
                                <label class="payment-option">
                                    <input type="radio" name="orderType" value="delivery" checked>
                                    <span class="payment-label"><i class="fas fa-truck"></i> Delivery</span>
                                </label>
                                <label class="payment-option" data-pos-only="true" id="orderTypeBalcaoWrapper" style="display:none;">
                                    <input type="radio" name="orderType" value="balcao">
                                    <span class="payment-label"><i class="fas fa-store"></i> Balcão</span>
                                </label>
                            </div>
                        </div>
                        
                    </div>
                    <div class="checkout-step" id="checkout-step-2">
                        <div class="form-section">
                            <h4><i class="fas fa-user"></i> Dados Pessoais</h4>
                            <div class="form-group">
                                <label for="customerName">Nome Completo *</label>
                                <input type="text" id="customerName" name="customerName" required>
                            </div>
                            <div class="form-group">
                                <label for="customerPhone">Telefone/WhatsApp *</label>
                                <input type="tel" id="customerPhone" name="customerPhone" placeholder="(XX) XXXXX-XXXX" maxlength="15" required>
                            </div>
                        </div>
                        
                    </div>
                    <div class="checkout-step" id="checkout-step-3">
                        <div class="form-section" id="deliveryAddressSection">
                            <h4><i class="fas fa-map-marker-alt"></i> Endereço para Entrega</h4>
                            <div class="form-group">
                                <label for="addressZip">CEP *</label>
                                <input type="text" id="addressZip" name="addressZip" placeholder="00000-000" maxlength="9">
                            </div>
                            <div class="form-group">
                                <label for="addressStreet">Rua *</label>
                                <input type="text" id="addressStreet" name="addressStreet" list="streetSuggestions" placeholder="Preencha o CEP para sugerir a rua" readonly>
                            </div>
                            <div class="form-group">
                                <label for="addressNumber">Número *</label>
                                <input type="text" id="addressNumber" name="addressNumber">
                            </div>
                            <div class="form-group">
                                <label for="customerNeighborhood">Bairro *</label>
                                <input type="text" id="customerNeighborhood" name="customerNeighborhood" list="neighbourhoodSuggestions" placeholder="Preencha o CEP para sugerir o bairro" readonly>
                            </div>
                            <div class="form-group">
                                <label for="addressCity">Cidade *</label>
                                <input type="text" id="addressCity" name="addressCity" placeholder="Preencha o CEP para sugerir a cidade" readonly>
                            </div>
                            <div class="form-group">
                                <label for="customerReference">Referência *</label>
                                <input type="text" id="customerReference" name="customerReference" placeholder="Ex.: Apto 301 Bloco B, Casa Amarela">
                            </div>
                            <div class="form-group">
                                <label for="addressComplement">Complemento (opcional)</label>
                                <input type="text" id="addressComplement" name="addressComplement">
                            </div>
                        </div>
                        
                    </div>
                    <div class="checkout-step" id="checkout-step-4">
                        <div class="form-section">
                            <h4><i class="fas fa-credit-card"></i> Forma de Pagamento</h4>
                            <div class="payment-options">
                                <label class="payment-option">
                                    <input type="radio" name="paymentMethod" value="dinheiro" checked>
                                    <span class="payment-label">
                                        <i class="fas fa-money-bill-wave"></i>
                                        Dinheiro
                                    </span>
                                </label>
                                <label class="payment-option">
                                    <input type="radio" name="paymentMethod" value="cartao">
                                    <span class="payment-label">
                                        <i class="fas fa-credit-card"></i>
                                        Cartão (na entrega)
                                    </span>
                                </label>
                                <label class="payment-option">
                                    <input type="radio" name="paymentMethod" value="pix">
                                    <span class="payment-label">
                                        <i class="fas fa-qrcode"></i>
                                        PIX
                                    </span>
                                </label>
                            </div>
                            
                            <div class="money-section" id="moneySection">
                                <div class="form-group">
                                    <label for="paymentValue">Valor para troco (opcional)</label>
                                    <input type="number" id="paymentValue" name="paymentValue" step="0.01" min="0">
                                    <small>Deixe em branco se não precisar de troco</small>
                                </div>
                                <div class="change-display" id="changeDisplay" style="display: none;">
                                    <span>Troco: <strong id="changeAmount">R$ 0,00</strong></span>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                    <div class="checkout-step" id="checkout-step-5">
                        <div class="form-section">
                            <h4><i class="fas fa-sticky-note"></i> Observações</h4>
                            <div class="form-group">
                                <label for="orderNotes">Observações do pedido</label>
                                <textarea id="orderNotes" name="orderNotes" rows="3" placeholder="Alguma observação especial?"></textarea>
                            </div>
                        </div>
                        <div class="order-summary">
                            <h4>Resumo do Pedido</h4>
                            <div id="checkoutItems"></div>
                            <div class="summary-totals">
                                <div class="summary-row">
                                    <span>Subtotal:</span>
                                    <span id="checkoutSubtotal">R$ 0,00</span>
                                </div>
                                <div class="summary-row">
                                    <span>Taxa de entrega:</span>
                                    <span id="checkoutDeliveryFee">R$ 5,00</span>
                                </div>
                                <div class="summary-row total">
                                    <span>Total:</span>
                                    <span id="checkoutTotal">R$ 0,00</span>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </form>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn-secondary" id="checkoutBackBtn" onclick="prevCheckoutStep()">Voltar</button>
                <button type="button" class="btn-primary" id="checkoutPrimaryBtn" onclick="nextCheckoutStepOrSubmit()">
                    <i class="fas fa-arrow-right"></i>
                    Continuar
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Processando seu pedido...</p>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal-overlay" id="successModal">
        <div class="modal success-modal">
            <div class="modal-content">
                <div class="success-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h3>Pedido Realizado com Sucesso!</h3>
                <p>Seu pedido foi recebido e está sendo preparado.</p>
                <div class="order-info">
                    <p><strong>Número do pedido:</strong> <span id="orderNumber"></span></p>
                    <p><strong>Tempo estimado:</strong> <span id="estimatedTime">30 minutos</span></p>
                </div>
                <div class="btn-row">
                    <button class="btn-primary" style="background:#25D366;border-color:#25D366;" onclick="openWhatsAppWithOrder()">
                        <i class="fab fa-whatsapp"></i>
                        Enviar e acompanhar no WhatsApp
                    </button>
                    <button class="btn-primary" onclick="closeSuccessModal()">
                        <i class="fas fa-home"></i>
                        Fazer Novo Pedido
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Pizza Builder Modal -->
    <div class="modal-overlay" id="pizzaBuilderModal">
        <div class="modal pizza-builder-modal">
            <div class="modal-content pizza-builder-content">
                <div class="modal-header">
                    <h3 id="pizzaBuilderTitle">🍕 Monte Sua Pizza</h3>
                    <button class="close-modal" onclick="closePizzaBuilder()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- Progress Bar -->
                    <div class="pizza-progress">
                        <div class="progress-step active" data-step="1">
                            <span class="step-number">1</span>
                            <span class="step-label">Tamanho</span>
                        </div>
                        <div class="progress-step" data-step="2">
                            <span class="step-number">2</span>
                            <span class="step-label">Sabores</span>
                        </div>
                        <div class="progress-step" data-step="3">
                            <span class="step-number">3</span>
                            <span class="step-label">Adicionais</span>
                        </div>
                        <div class="progress-step" data-step="4">
                            <span class="step-number">4</span>
                            <span class="step-label">Resumo</span>
                        </div>
                    </div>

                    <!-- Step 1: Tamanho -->
                    <div class="pizza-step active" id="step-1">
                        <div class="step-header">
                            <h4>Escolha o Tamanho da Sua Pizza</h4>
                            <p>O tamanho define quantos sabores você pode escolher</p>
                        </div>
                        
                        <div class="sizes-grid" id="sizesGrid">
                            <!-- Tamanhos serão carregados aqui -->
                        </div>
                        
                        <div class="step-actions">
                            <button class="btn btn-primary" onclick="nextPizzaStep()" disabled id="nextStep1">
                                Continuar <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Step 2: Sabores -->
                    <div class="pizza-step" id="step-2">
                        <div class="step-header">
                            <h4>Escolha os Sabores</h4>
                            <p id="flavorsInfo">Selecione até <span id="maxFlavors">1</span> sabor</p>
                            <div class="parts-info" style="margin-top:8px;font-size:13px;color:#666;">
                                Partes usadas: <strong><span id="usedPartsCounter">0</span></strong> / <strong><span id="totalPartsCounter">0</span></strong>
                            </div>
                        </div>
                        
                        <div class="flavors-container">
                            <div class="pizza-visual">
                                <div class="pizza-circle" id="pizzaCircle">
                                    <!-- Círculo da pizza será renderizado aqui -->
                                </div>
                                <div class="pizza-info">
                                    <h5 id="selectedSizeName">Tamanho</h5>
                                    <p id="selectedSizeInfo">Informações do tamanho</p>
                                </div>
                            </div>
                            
                            <div class="flavors-selection">
                                <div class="flavor-categories">
                                    <button class="category-btn active" data-category="all">Todos</button>
                                    <button class="category-btn" data-category="tradicional">Tradicionais</button>
                                    <button class="category-btn" data-category="especial">Especiais</button>
                                    <button class="category-btn" data-category="doce">Doces</button>
                                </div>
                                
                                <div class="flavors-grid" id="flavorsGrid">
                                    <!-- Sabores serão carregados aqui -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="step-actions">
                            <button class="btn btn-secondary" onclick="previousPizzaStep()">
                                <i class="fas fa-arrow-left"></i> Voltar
                            </button>
                            <button class="btn btn-primary" onclick="nextPizzaStep()" disabled id="nextStep2">
                                Continuar <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Step 3: Adicionais -->
                    <div class="pizza-step" id="step-3">
                        <div class="step-header">
                            <h4>Adicionais (Opcional)</h4>
                            <p>Adicione ingredientes extras à sua pizza</p>
                        </div>
                        
                        <div class="extras-container">
                            <div class="extras-categories">
                                <button class="category-btn active" data-category="all">Todos</button>
                                <button class="category-btn" data-category="queijo">Queijos</button>
                                <button class="category-btn" data-category="carne">Carnes</button>
                                <button class="category-btn" data-category="vegetal">Vegetais</button>
                            </div>
                            
                            <div class="extras-grid" id="extrasGrid">
                                <!-- Adicionais serão carregados aqui -->
                            </div>
                        </div>
                        
                        <div class="step-actions">
                            <button class="btn btn-secondary" onclick="previousPizzaStep()">
                                <i class="fas fa-arrow-left"></i> Voltar
                            </button>
                            <button class="btn btn-primary" onclick="nextPizzaStep()" id="nextStep3">
                                Continuar <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Step 4: Resumo -->
                    <div class="pizza-step" id="step-4">
                        <div class="step-header">
                            <h4>Resumo da Sua Pizza</h4>
                            <p>Confirme os detalhes antes de adicionar ao carrinho</p>
                        </div>
                        
                        <div class="pizza-summary">
                            <div class="summary-visual">
                                <div class="pizza-preview" id="pizzaPreview">
                                    <!-- Preview da pizza -->
                                </div>
                            </div>
                            
                            <div class="summary-details">
                                <div class="summary-item">
                                    <h5>Tamanho</h5>
                                    <p id="summarySize">-</p>
                                </div>
                                
                                <div class="summary-item">
                                    <h5>Sabores</h5>
                                    <p id="summaryFlavors">-</p>
                                </div>
                                
                                
                                
                                <div class="summary-item" id="summaryExtrasContainer" style="display: none;">
                                    <h5>Adicionais</h5>
                                    <p id="summaryExtras">-</p>
                                </div>
                                
                                <div class="summary-price">
                                    <h5>Preço Total</h5>
                                    <p class="price" id="summaryPrice">R$ 0,00</p>
                                </div>

                                <!-- Observações e Preferências (inspirado no fluxo mobile) -->
                                <div class="summary-item" style="margin-top:16px;">
                                    <h5>Observações (Opcional)</h5>
                                    <textarea id="pizzaObservations" rows="3" placeholder="Ex: Sem cebola, bem passada, etc..." style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px;font-family:inherit;"></textarea>
                                </div>
                                <div class="summary-item" style="margin-top:12px;">
                                    <h5>Preferências de Preparo</h5>
                                    <div class="prefs-grid" style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px;margin-top:8px;">
                                        <label style="display:flex;align-items:center;gap:8px;font-size:14px;"><input type="checkbox" class="pizza-pref" value="Bem passada"> Bem passada</label>
                                        <label style="display:flex;align-items:center;gap:8px;font-size:14px;"><input type="checkbox" class="pizza-pref" value="Queijo extra"> Queijo extra</label>
                                        <label style="display:flex;align-items:center;gap:8px;font-size:14px;"><input type="checkbox" class="pizza-pref" value="Borda crocante"> Borda crocante</label>
                                        <label style="display:flex;align-items:center;gap:8px;font-size:14px;"><input type="checkbox" class="pizza-pref" value="Sem cebola"> Sem cebola</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="step-actions">
                            <button class="btn btn-secondary" onclick="previousPizzaStep()">
                                <i class="fas fa-arrow-left"></i> Voltar
                            </button>
                            <button class="btn btn-success" onclick="addPizzaToCart()" id="addToCartBtn">
                                <i class="fas fa-shopping-cart"></i> Adicionar ao Carrinho
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cart Overlay (for mobile) -->
    <div class="cart-overlay" id="cartOverlay" onclick="toggleCart()"></div>

    <!-- Modal de sucesso (Pizza adicionada) -->
    <div class="pizza-add-success-overlay" id="pizzaAddSuccess">
        <div class="pizza-add-success-modal">
            <div style="font-size:56px; margin-bottom: 8px;">🎉</div>
            <div class="title">Pizza Adicionada!</div>
            <div class="desc">Sua deliciosa pizza foi adicionada ao carrinho com sucesso.</div>
            <div class="pizza-add-success-actions">
                <button type="button" class="btn-outline" id="btnContinueShopping">Continuar comprando</button>
                <button type="button" class="btn-emerald" id="btnGoToCart">Ir para o carrinho</button>
            </div>
        </div>
    </div>

    <!-- Modal de Horário Fechado com Cronômetro (integrado às configurações) -->
    <div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4" style="z-index:2147483647;">
        <div id="modal-content" class="w-full max-w-md bg-white rounded-2xl shadow-xl p-8 text-center transform transition-all">
            <div class="mx-auto mb-4 h-14 w-14 flex items-center justify-center bg-gray-100 rounded-full">
                <svg class="h-7 w-7 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </div>
            <h2 class="text-2xl font-bold text-gray-900">Estamos fechados no momento</h2>
            <p class="text-gray-600 mt-2">
               Funcionamos <strong id="hoursRange" class="font-semibold text-gray-800"></strong>.
            </p>
            <div class="mt-6">
                <p class="text-xs uppercase tracking-wider text-gray-500 font-medium">Falta para abrir</p>
                <div id="countdown" class="text-5xl font-bold text-gray-900 tracking-tight mt-2">
                    <span id="hours" >00</span><span class="text-3xl mx-1">:</span><span id="minutes">00</span><span class="text-3xl mx-1">:</span><span id="seconds">00</span>
                </div>
            </div>
            <p class="text-gray-500 mt-6 text-sm">Agradecemos a preferência.</p>
        </div>
    </div>

    <script src="assets/js/app.js"></script>
    <script>
        // Usa businessHours e isWithinBusinessHours carregados em assets/js/app.js
        (function() {
            const overlay = document.getElementById('modal-overlay');
            const hEl = document.getElementById('hours');
            const mEl = document.getElementById('minutes');
            const sEl = document.getElementById('seconds');
            const rangeEl = document.getElementById('hoursRange');

            function toHM(str) {
                const [h, m] = String(str || '00:00').split(':').map(n => parseInt(n, 10));
                return { h: isNaN(h) ? 0 : h, m: isNaN(m) ? 0 : m };
            }

            function getTodayHours(hours) {
                if (!hours) return null;
                const map = ['sunday','monday','tuesday','wednesday','thursday','friday','saturday'];
                const key = map[new Date().getDay()];
                return hours[key] || null;
            }

            function computeNextOpening(hours) {
                const now = new Date();
                const dow = now.getDay();
                const map = ['sunday','monday','tuesday','wednesday','thursday','friday','saturday'];
                const today = hours[map[dow]];
                let next = new Date(now);
                next.setSeconds(0); next.setMilliseconds(0);
                if (today && !today.closed) {
                    const o = toHM(today.open);
                    const c = toHM(today.close);
                    const nowMin = now.getHours()*60+now.getMinutes();
                    const openMin = o.h*60+o.m, closeMin = c.h*60+c.m;
                    if (nowMin < openMin) {
                        next.setHours(o.h, o.m, 0, 0);
                        return next;
                    }
                }
                for (let i=1;i<=7;i++) {
                    const idx = (dow + i) % 7;
                    const d = hours[map[idx]];
                    if (d && !d.closed) {
                        const o = toHM(d.open);
                        next = new Date(now);
                        next.setDate(now.getDate()+i);
                        next.setHours(o.h, o.m, 0, 0);
                        return next;
                    }
                }
                return null;
            }

            function formatRange(hours) {
                if (!hours) return '';
                // Se todos os dias iguais, mostra faixa única, senão mostra hoje
                const days = ['monday','tuesday','wednesday','thursday','friday','saturday','sunday'];
                const first = hours[days[0]];
                const allEqual = days.every(k => JSON.stringify(hours[k]) === JSON.stringify(first));
                const pad = v => String(v).padStart(2,'0');
                if (allEqual && first && !first.closed) {
                    const o = toHM(first.open), c = toHM(first.close);
                    return `${pad(o.h)}:${pad(o.m)} às ${pad(c.h)}:${pad(c.m)}`;
                }
                const today = getTodayHours(hours);
                if (today && !today.closed) {
                    const o = toHM(today.open), c = toHM(today.close);
                    return `${pad(o.h)}:${pad(o.m)} às ${pad(c.h)}:${pad(c.m)} (hoje)`;
                }
                return 'Consulte nossos horários';
            }

            function tick() {
                if (typeof isWithinBusinessHours === 'undefined') return;
                if (isWithinBusinessHours) {
                    overlay.style.display = 'none';
                    try { document.documentElement.style.overflow = ''; document.body.style.overflow = ''; } catch(_){}
                    return;
                }
                overlay.style.display = 'flex';
                try { document.documentElement.style.overflow = 'hidden'; document.body.style.overflow = 'hidden'; } catch(_){}
                if (businessHours) {
                    rangeEl.textContent = formatRange(businessHours);
                    const next = computeNextOpening(businessHours);
                    if (next) {
                        const now = new Date();
                        const total = Math.max(0, Math.floor((next - now)/1000));
                        const hh = Math.floor(total/3600);
                        const mm = Math.floor((total%3600)/60);
                        const ss = total%60;
                        hEl.textContent = String(hh).padStart(2,'0');
                        mEl.textContent = String(mm).padStart(2,'0');
                        sEl.textContent = String(ss).padStart(2,'0');
                    }
                }
            }
            setInterval(tick, 1000);
            document.addEventListener('DOMContentLoaded', tick);
        })();
    </script>
</body>
</html>

